<?php

$template = <<<TPL
---
layout: report
image: ___ENGAGEMENT_PREVIEW_IMAGE___ 
team: ___TEAM___
engagement_name: ___ENGAGEMENT___ 
engagement_preview_file: ___ENGAGEMENT_PREVIEW_IMAGE___ 
engagement_pdf_file: ___ENGAGEMENT_PDF_FILE___ 

# Page specifics
title: ___TEAM___ - ___ENGAGEMENT___ 
description: View and download a complete penetration test report from ___TEAM___. Learn about ___TEAM___'s methodology and tools used in pentest reports.
---
TPL;

$tpl = <<<TPL
items:

TPL;

$dir = opendir('reports');
while($entry = readdir($dir)) {
	if(!in_array($entry, ['.', '..', 'index.md'])) {
		echo "Entry: $entry\n";
		$reportDirName = "reports/$entry";
		$subdir = opendir($reportDirName);
		while($file = readdir($subdir)) {
			if($file != '.' && $file != '..' && preg_match('/.pdf$/', $file)) {
				echo "file: $file\n";
				$basefile = substr($file, 0, -4);
				$title = str_replace(['_'], [' '], $basefile);
				$pageTitle = "$entry - $title";
				$pageDescription = sprintf("View and download a complete penetration test report from %s. Learn about %s's methodology and tools used in pentest reports.", $entry, $entry);
				$content = sprintf($template, $pageTitle, $pageDescription, $entry, $title, $basefile, $file);
				$replacements = [
					'___TEAM___' => $entry,
					'___ENGAGEMENT___' => $title,
					'___ENGAGEMENT_PREVIEW_IMAGE___' => "/reports/$entry/$basefile.png",
					'___ENGAGEMENT_PDF_FILE___' => $basefile . '.pdf'
				];
				$content = str_replace(array_keys($replacements), array_values($replacements), $template);
				file_put_contents("reports/$entry/$basefile.md", $content);
				$tpl .= '  - name: ' . "$entry - $title" . PHP_EOL;
				$tpl .= '    link: /reports/' . urlencode($entry) . '/' . $basefile . '.html'. PHP_EOL;

				exec("pdftoppm -singlefile -png -f 1 -l 1 ". escapeshellarg("$reportDirName/$file") ." " . escapeshellarg("$reportDirName/$basefile"));
			}
		}
		closedir($subdir);
	}
}
file_put_contents('_data/reports.yml', $tpl);
closedir($dir);

