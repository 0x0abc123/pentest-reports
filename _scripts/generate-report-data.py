#!/usr/bin/env python3
# -*- coding: utf-8 -*-

template = """---
layout: report
image: {ENGAGEMENT_PREVIEW_IMAGE} 
team: {TEAM}
engagement_name: {ENGAGEMENT} 
engagement_preview_file: {ENGAGEMENT_PREVIEW_IMAGE} 
engagement_pdf_file: {ENGAGEMENT_PDF_FILE} 
report_keywords: {KEYWORDS}

# Page specifics
title: {TEAM} - {ENGAGEMENT} 
description: View and download a complete penetration test report from {TEAM}. Learn about {TEAM}'s methodology and tools used in pentest reports.
---
"""

data = {
	"items": []
}

import os

from typing import List
import subprocess
from shlex import quote

import pandas as pd
import PyPDF2
from gensim.summarization import keywords

def extract_pdf_keywords(pdf_filename) -> List[str]:
	report_keywords = []
	with open(pdf_filename, 'rb') as pdf_fd:
		pdf_reader = PyPDF2.PdfFileReader(pdf_fd)
		text = ""
		for page in pdf_reader.pages:
			try:
				text += page.extractText().lower()
			except:
				pass

		values = keywords(text = text, split = '\n', scores = True)
		data = pd.DataFrame(values, columns = ['keyword', 'score'])
		data = data.sort_values('score', ascending = False)
		report_keywords = data["keyword"].tolist()
	return report_keywords


for entry in os.listdir("reports"):
	if entry not in [".", "..", "index.md"]:
		print(f"Entry: {entry}\n")
		reportDirName = "reports/" + entry
		for file in os.listdir(os.path.join("reports", entry)):
			if file.endswith(".pdf"):
				pdf_filename = f"{reportDirName}/{file}"
				print(f"file: {file}\n")

				report_keywords = extract_pdf_keywords(pdf_filename)
				print(report_keywords)

				basefile = file[0:-4]
				title = basefile.replace('_', ' ')
				pageTitle = "$entry - $title"
				pageDescription = "View and download a complete penetration test report from %s. Learn about %s's methodology and tools used in pentest reports." % (entry, entry)
				content = template.format(
						TEAM = entry,
						ENGAGEMENT = title, 
						ENGAGEMENT_PREVIEW_IMAGE = f"/reports/{entry}/{basefile}.png",
						ENGAGEMENT_PDF_FILE = basefile + '.pdf',
						KEYWORDS = ', '.join(report_keywords)
						)
				with open(f"reports/{entry}/{basefile}.md", 'w') as fd:
					fd.write(content)

				data["items"].append({
					"name": f"{entry} - {title}",
					"link": f"/reports/{entry}/{basefile}.html" 
				})

				os.system("pdftoppm -singlefile -png -f 1 -l 1 " + quote(pdf_filename) + " " + quote(f"{reportDirName}/{basefile}"))

import yaml

class Dumper(yaml.Dumper):
	def increase_indent(self, flow=False, *args, **kwargs):
		return super().increase_indent(flow=flow, indentless=False)

with open("_data/reports.yml", 'w') as fd:
    fd.write(yaml.dump(data, sort_keys=False, Dumper=Dumper))

